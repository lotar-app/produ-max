<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Accesso Produ-Max</title>
  <link rel="stylesheet" href="css/layout.css" />
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #f5f6fa;
      font-family: 'Helvetica Neue', Arial, sans-serif;
    }

    .login-card {
      width: 100%;
      max-width: 380px;
      background: #fff;
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 20px 45px rgba(52, 73, 94, 0.15);
    }

    .login-card h1 {
      margin: 0 0 8px;
      font-size: 24px;
      text-align: center;
    }

    .login-card p {
      margin: 0 0 24px;
      text-align: center;
      color: #7f8c8d;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: #2c3e50;
    }

    select,
    input[type="password"] {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 16px;
      border: 1px solid #dfe6e9;
      border-radius: 6px;
      font-size: 16px;
    }

    button {
      width: 100%;
      padding: 12px;
      background-color: #2c3e50;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .error-box {
      display: none;
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 6px;
      background-color: #fdecea;
      color: #c0392b;
      border: 1px solid #f8c9c6;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 8px;
    }

    .badge.dev {
      background-color: #c0392b;
      color: #fff;
    }

    .badge.stable {
      background-color: #27ae60;
      color: #fff;
    }

    .assist {
      margin-top: 14px;
      font-size: 13px;
      line-height: 1.3;
      color: #95a5a6;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="login-card">
    <h1>Accesso Produ-Max</h1>
    <p>Inserisci le tue credenziali di accesso.</p>
    <div id="env-indicator"></div>
    <div id="error-box" class="error-box"></div>
    <form id="login-form" autocomplete="off">
      <label for="username">Username</label>
      <input type="text" id="username" name="username" required autofocus />

      <label for="password">Password</label>
      <input type="password" id="password" name="password" required />

      <button type="submit" id="login-button">Accedi</button>
      <p class="assist">
        Se non ricordi le credenziali di accesso contatta Max Contrucci per il reset.
      </p>
    </form>
  </div>

  <script src="js/env.js"></script>
  <script>
    (function init() {
      const form = document.getElementById('login-form');
      const errorBox = document.getElementById('error-box');
      const loginButton = document.getElementById('login-button');

      function showError(message) {
        errorBox.textContent = message;
        errorBox.style.display = 'block';
      }

      function hideError() {
        errorBox.style.display = 'none';
      }

      function updateEnvIndicator() {
        const host = (window.location && window.location.hostname) || '';
        const isDev = host.includes('dev') || host.includes('localhost') || host.includes('clone');
        const indicator = document.getElementById('env-indicator');
        if (!indicator) return;
        indicator.innerHTML = '';
        const badge = document.createElement('span');
        badge.className = 'badge ' + (isDev ? 'dev' : 'stable');
        badge.textContent = isDev ? 'SVILUPPO' : 'STABILE';
        indicator.appendChild(badge);
      }

      async function checkAuthStatus() {
        try {
          const res = await fetch('/api/auth/status', { credentials: 'include' });
          if (!res.ok) throw new Error('Richiesta status fallita');
          const data = await res.json();
          if (!data.authEnabled) {
            showError('La protezione con password non è attiva su questo ambiente.');
            loginButton.disabled = true;
          }
        } catch (err) {
          console.error('Impossibile verificare lo stato di autenticazione:', err);
        }
      }

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        hideError();
        loginButton.disabled = true;
        loginButton.textContent = 'Accesso in corso…';

        const formData = new FormData(form);
        const payload = {
          username: formData.get('username'),
          password: formData.get('password')
        };

        try {
          const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            const errData = await res.json().catch(() => ({ error: 'Errore sconosciuto' }));
            throw new Error(errData.error || 'Credenziali non valide');
          }

          const data = await res.json();
          if (data.role) {
            try {
              sessionStorage.setItem('ruolo', data.role);
              if (data.username) sessionStorage.setItem('authUsername', data.username);
              if (data.displayName) sessionStorage.setItem('authDisplayName', data.displayName);
            } catch (err) {
              console.warn('Impossibile salvare ruolo:', err);
            }
          }

          const urlParams = new URLSearchParams(window.location.search);
          const redirectTarget = urlParams.get('redirect') || 'vista_dinamica.html';
          window.location.replace(redirectTarget);
        } catch (err) {
          showError(err.message);
          loginButton.disabled = false;
          loginButton.textContent = 'Accedi';
        }
      });

      updateEnvIndicator();
      checkAuthStatus();
    })();
  </script>
</body>
</html>
